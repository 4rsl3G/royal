<div class="fade-up">
  <div class="card card-pad scanline">
    <div class="card-row">
      <div class="min-w-0">
        <div class="pill"><i class="ri-file-list-3-line"></i> Management</div>
        <div class="card-title mt-2">Orders</div>
        <div class="card-sub">Filter, cari, dan update fulfill status + catatan admin.</div>
      </div>

      <div class="flex gap-2 flex-wrap">
        <button class="btn btn-ghost" id="btnRefresh"><i class="ri-refresh-line"></i> Refresh</button>
        <button class="btn btn-primary shimmer" id="btnQuickPending">
          <i class="ri-time-line"></i> Pending
        </button>
        <button class="btn btn-primary shimmer" id="btnQuickWaiting">
          <i class="ri-hourglass-2-line"></i> Waiting
        </button>
      </div>
    </div>

    <div class="mt-4 form-grid">
      <div class="col-6">
        <div class="label">Search</div>
        <input id="q" class="input" placeholder="order_id / game_id / wa / product" />
      </div>

      <div class="col-3">
        <div class="label">Pay Status</div>
        <select id="pay_status" class="select">
          <option value="">all</option>
          <option>pending</option>
          <option>settlement</option>
          <option>capture</option>
          <option>expire</option>
          <option>cancel</option>
          <option>deny</option>
          <option>failure</option>
        </select>
      </div>

      <div class="col-3">
        <div class="label">Fulfill</div>
        <select id="fulfill_status" class="select">
          <option value="">all</option>
          <option value="waiting">waiting</option>
          <option value="processing">processing</option>
          <option value="done">done</option>
          <option value="rejected">rejected</option>
        </select>
      </div>

      <div class="col-12">
        <div class="help">
          Tip: gunakan quick filter “Pending” untuk cek pembayaran, dan “Waiting” untuk antrian proses.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TABLE (DataTables) -->
<div class="mt-4 card card-pad fade-up">
  <div class="card-row">
    <div class="font-extrabold text-lg">Orders Table</div>
    <div class="pill"><i class="ri-database-2-line"></i> <span id="countBox">0</span> items</div>
  </div>

  <div class="mt-4" style="overflow:auto; -webkit-overflow-scrolling: touch;">
    <table id="ordersTable" class="display nowrap stripe hover" style="width:100%">
      <thead>
        <tr>
          <th>Order</th>
          <th>Produk</th>
          <th>Customer</th>
          <th>Amount</th>
          <th>Pay</th>
          <th>Fulfill</th>
          <th class="text-right">Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="mt-3 help">
    Showing <b>5</b> per page. Gunakan pagination di bawah tabel.
  </div>
</div>

<!-- MODAL -->
<div id="modal" class="hidden">
  <div class="rd-modal-wrap">
    <div class="rd-modal-card card card-pad" style="width:100%;max-width:720px;">
      <div class="card-row">
        <div class="min-w-0">
          <div class="font-extrabold text-lg">Update Fulfill</div>
          <div class="text-sm text-slate-500">Update status + admin note (dipakai template WA).</div>
        </div>
        <button class="btn btn-ghost" id="closeModal"><i class="ri-close-line"></i></button>
      </div>

      <div class="mt-4 grid md:grid-cols-2 gap-3">
        <div class="card soft card-pad" style="border-radius:18px;border:1px solid var(--line2);">
          <div class="text-xs text-slate-500">Order ID</div>
          <div class="font-extrabold mt-1 break-anywhere" id="mOrderId">-</div>

          <div class="text-xs text-slate-500 mt-3">Pay</div>
          <div class="mt-1" id="mPayBadge">-</div>

          <div class="text-xs text-slate-500 mt-3">Gross</div>
          <div class="font-extrabold mt-1" id="mGross">-</div>
        </div>

        <div class="card soft card-pad" style="border-radius:18px;border:1px solid var(--line2);">
          <div class="label">Fulfill Status</div>
          <select id="mFulfill" class="select">
            <option value="waiting">waiting</option>
            <option value="processing">processing</option>
            <option value="done">done</option>
            <option value="rejected">rejected</option>
          </select>

          <div class="label mt-3">Admin Note</div>
          <textarea id="mNote" class="textarea" rows="5" placeholder="Catatan untuk customer (dipakai di template WA)"></textarea>

          <div class="mt-3">
            <button class="btn btn-primary shimmer btn-block" id="saveBtn">
              <i class="ri-save-3-line"></i> Simpan
            </button>
          </div>
        </div>
      </div>

      <div class="mt-3 help">
        Saran: set “processing” saat mulai pengerjaan. “done”/“rejected” akan memicu template WA (jika enabled + connected).
      </div>
    </div>
  </div>
</div>

<script>
  function rupiah(n){ return 'Rp ' + (Number(n||0)).toLocaleString('id-ID'); }

  function escapeHtml(s){
    return String(s || '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  function payBadge(st){
    st = String(st||'').toLowerCase();
    if(st === 'settlement' || st === 'capture') return `<span class="badge good"><i class="ri-check-line"></i> ${st}</span>`;
    if(st === 'pending') return `<span class="badge warn"><i class="ri-time-line"></i> ${st}</span>`;
    if(st === 'expire' || st === 'cancel' || st === 'deny' || st === 'failure') return `<span class="badge bad"><i class="ri-close-line"></i> ${st}</span>`;
    return `<span class="badge"><i class="ri-question-line"></i> ${escapeHtml(st || '-')}</span>`;
  }

  function fulfillBadge(st){
    st = String(st||'').toLowerCase();
    if(st === 'done') return `<span class="badge good"><i class="ri-check-double-line"></i> done</span>`;
    if(st === 'processing') return `<span class="badge info"><i class="ri-loader-4-line"></i> processing</span>`;
    if(st === 'waiting') return `<span class="badge warn"><i class="ri-hourglass-2-line"></i> waiting</span>`;
    if(st === 'rejected') return `<span class="badge bad"><i class="ri-close-line"></i> rejected</span>`;
    return `<span class="badge">${escapeHtml(st||'-')}</span>`;
  }

  let DT = null;
  let CURRENT = null;
  let CURRENT_ROW = null;

  function openModalFromRow(row){
    CURRENT_ROW = row;
    CURRENT = row.order_id;

    $('#mOrderId').text(CURRENT);
    $('#mFulfill').val(row.fulfill_status || 'waiting');
    $('#mNote').val(row.admin_note || '');
    $('#mPayBadge').html(payBadge(row.pay_status || '-'));
    $('#mGross').text(rupiah(row.gross_amount || 0));

    $('body').addClass('modal-open');
    $('#modal').removeClass('hidden');
  }

  function closeModal(){
    // trigger anim close via CSS (#modal.hidden => opacity 0)
    $('#modal').addClass('hidden');
    $('body').removeClass('modal-open');
    CURRENT = null;
    CURRENT_ROW = null;
  }

  function buildDataTable(){
    if (DT) { DT.destroy(); $('#ordersTable tbody').empty(); }

    DT = $('#ordersTable').DataTable({
      responsive: true,
      autoWidth: false,
      pageLength: 5,
      lengthChange: false,
      processing: true,
      deferRender: true,
      order: [[0, 'desc']],
      language: {
        info: "Menampilkan _START_ - _END_ dari _TOTAL_ orders",
        infoEmpty: "Tidak ada data",
        paginate: { previous: "‹", next: "›" },
        emptyTable: "Tidak ada data",
        zeroRecords: "Tidak ada data cocok"
      },
      columns: [
        {
          data: null,
          render: function(_, __, row){
            const t = escapeHtml(String(row.created_at||'').replace('T',' ').slice(0,19));
            return `
              <div class="font-extrabold break-anywhere">${escapeHtml(row.order_id)}</div>
              <div class="text-xs text-slate-500 mt-1">${t}</div>
            `;
          }
        },
        {
          data: null,
          render: function(_, __, row){
            return `
              <div class="font-extrabold">${escapeHtml(row.product_name || '-')}</div>
              <div class="text-xs text-slate-500 mt-1">qty: ${Number(row.qty||0)} • unit: ${rupiah(row.unit_price||0)}</div>
            `;
          }
        },
        {
          data: null,
          render: function(_, __, row){
            return `
              <div class="font-extrabold">${escapeHtml(row.game_id || '-')}</div>
              <div class="text-xs text-slate-500 mt-1">${escapeHtml(row.nickname || '-')} • ${escapeHtml(row.whatsapp || '-')}</div>
            `;
          }
        },
        {
          data: "gross_amount",
          render: function(v){
            return `<div class="font-extrabold">${rupiah(v||0)}</div>`;
          }
        },
        {
          data: "pay_status",
          orderable: false,
          render: function(v){ return payBadge(v); }
        },
        {
          data: "fulfill_status",
          orderable: false,
          render: function(v){ return fulfillBadge(v); }
        },
        {
          data: null,
          orderable: false,
          className: "dt-body-right",
          render: function(_, __, row){
            const note = escapeHtml(row.admin_note || '');
            return `
              <button class="btn btn-sm js-edit"
                data-oid="${escapeHtml(row.order_id)}"
                data-pay="${escapeHtml(row.pay_status)}"
                data-ful="${escapeHtml(row.fulfill_status)}"
                data-note="${note}"
                data-gross="${escapeHtml(String(row.gross_amount||0))}">
                <i class="ri-pencil-line"></i> Edit
              </button>
            `;
          }
        }
      ]
    });
  }

  async function load(){
    const qs = $.param({
      q: $('#q').val(),
      pay_status: $('#pay_status').val(),
      fulfill_status: $('#fulfill_status').val()
    });

    try {
      RD.ui.overlay(true);

      const resp = await $.ajax({
        method:'GET',
        url: window.__ADMIN_BASE + '/api/orders?' + qs,
        headers: { 'X-CSRF-Token': window.__CSRF_TOKEN }
      });

      if (!resp.ok) throw new Error(resp.message || 'Failed');

      const data = resp.data || [];
      $('#countBox').text(data.length);

      if (!DT) buildDataTable();

      DT.clear();
      DT.rows.add(data);
      DT.draw();

    } catch(e) {
      toastr.error(e.message || 'Failed load orders');
      if (DT){
        DT.clear().draw();
      }
    } finally {
      RD.ui.overlay(false);
    }
  }

  // EVENTS
  $('#btnRefresh').on('click', load);

  $('#btnQuickPending').on('click', function(){
    $('#pay_status').val('pending');
    $('#fulfill_status').val('');
    load();
  });

  $('#btnQuickWaiting').on('click', function(){
    $('#fulfill_status').val('waiting');
    $('#pay_status').val('');
    load();
  });

  // search input: pakai debounce dan reload API (biar hasil akurat)
  $('#q').on('keyup', RD.util.debounce(load, 350));
  $('#pay_status, #fulfill_status').on('change', load);

  // edit click: DataTables safe (child row fix)
  $(document).off('click', '#ordersTable .js-edit').on('click', '#ordersTable .js-edit', function(){
    const oid = String($(this).data('oid') || '');
    const row = DT.rows().data().toArray().find(x => String(x.order_id) === oid);
    if (row) openModalFromRow(row);
  });

  $('#closeModal').on('click', closeModal);
  $('#modal').on('click', (e) => { if (e.target.id==='modal') closeModal(); });

  $(document).on('keydown', function(e){
    if (e.key === 'Escape' && !$('#modal').hasClass('hidden')) closeModal();
  });

  $('#saveBtn').on('click', async function(){
    if (!CURRENT) return;
    RD.ui.overlay(true);
    try {
      const resp = await $.ajax({
        method:'POST',
        url: window.__ADMIN_BASE + '/api/orders/' + encodeURIComponent(CURRENT) + '/fulfill',
        data: {
          fulfill_status: $('#mFulfill').val(),
          admin_note: $('#mNote').val()
        },
        headers: { 'X-CSRF-Token': window.__CSRF_TOKEN }
      });
      if (!resp.ok) throw new Error(resp.message || 'Failed');
      toastr.success('Saved');
      closeModal();
      load();
    } catch(e) {
      toastr.error(e.responseJSON?.message || e.message || 'Failed');
    } finally {
      RD.ui.overlay(false);
    }
  });

  // cleanup when leaving route
  RD.router.onLeave(() => {
    try{
      if (DT){ DT.destroy(); DT = null; }
    }catch(_){}
    $(document).off('click', '#ordersTable .js-edit');
    $(document).off('keydown');
  });

  // boot
  buildDataTable();
  load();
</script>
