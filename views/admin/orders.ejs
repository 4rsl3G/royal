<div class="fade-up">
  <div class="card card-pad scanline">
    <div class="card-row">
      <div class="min-w-0">
        <div class="pill"><i class="ri-file-list-3-line"></i> Management</div>
        <div class="card-title mt-2">Orders</div>
        <div class="card-sub">Filter, cari, dan update fulfill status + catatan admin.</div>
      </div>

      <div class="flex gap-2 flex-wrap">
        <button class="btn btn-ghost" id="btnRefresh"><i class="ri-refresh-line"></i> Refresh</button>
        <button class="btn btn-primary shimmer" id="btnQuickPending">
          <i class="ri-time-line"></i> Pending
        </button>
        <button class="btn btn-primary shimmer" id="btnQuickWaiting">
          <i class="ri-hourglass-2-line"></i> Waiting
        </button>
      </div>
    </div>

    <div class="mt-4 form-grid">
      <div class="col-6">
        <div class="label">Search</div>
        <input id="q" class="input" placeholder="order_id / game_id / wa / product" />
      </div>

      <div class="col-3">
        <div class="label">Pay Status</div>
        <select id="pay_status" class="select">
          <option value="">all</option>
          <option>pending</option>
          <option>settlement</option>
          <option>capture</option>
          <option>expire</option>
          <option>cancel</option>
          <option>deny</option>
          <option>failure</option>
        </select>
      </div>

      <div class="col-3">
        <div class="label">Fulfill</div>
        <select id="fulfill_status" class="select">
          <option value="">all</option>
          <option value="waiting">waiting</option>
          <option value="processing">processing</option>
          <option value="done">done</option>
          <option value="rejected">rejected</option>
        </select>
      </div>

      <div class="col-12">
        <div class="help">
          Tip: gunakan quick filter “Pending” untuk cek pembayaran, dan “Waiting” untuk antrian proses.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- DESKTOP TABLE CARD (scroll INSIDE card body) -->
<div class="mt-4 card fade-up" id="tableWrap">
  <div class="card-pad card-head">
    <div class="card-row">
      <div class="font-extrabold text-lg">Table</div>
      <div class="pill"><i class="ri-database-2-line"></i> <span id="countBox">0</span> rows</div>
    </div>
  </div>

  <!-- scroll hanya di sini -->
  <div class="card-body orders-scroll">
    <table class="table">
      <thead>
        <tr>
          <th>Order</th>
          <th>Produk</th>
          <th>Customer</th>
          <th>Amount</th>
          <th>Pay</th>
          <th>Fulfill</th>
          <th class="td-actions">Action</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- MOBILE CARD LIST (scroll INSIDE card body) -->
<div class="mt-4 fade-up" id="cardsWrap" style="display:none;">
  <div class="card">
    <div class="card-pad card-head">
      <div class="card-row">
        <div class="font-extrabold text-lg">Orders</div>
        <div class="pill"><i class="ri-database-2-line"></i> <span id="countBox2">0</span> items</div>
      </div>
    </div>

    <!-- scroll hanya di sini -->
    <div class="card-body orders-scroll" id="cardsBox"></div>
  </div>
</div>

<!-- MODAL -->
<div id="modal" class="hidden fixed inset-0 z-50 bg-black/30 backdrop-blur-sm">
  <div class="rd-modal-wrap" role="dialog" aria-modal="true">
    <div class="rd-modal-card card card-pad" style="width:100%;max-width:680px;">
      <div class="card-row">
        <div class="min-w-0">
          <div class="font-extrabold text-lg">Update Fulfill</div>
          <div class="text-sm text-slate-500">Update status + admin note (dipakai template WA).</div>
        </div>
        <button class="btn btn-ghost" id="closeModal"><i class="ri-close-line"></i></button>
      </div>

      <div class="rd-modal-body">
        <div class="mt-4 grid md:grid-cols-2 gap-3">
          <div class="card soft card-pad" style="border-radius:18px;border:1px solid var(--line2);">
            <div class="text-xs text-slate-500">Order ID</div>
            <div class="font-extrabold mt-1" id="mOrderId">-</div>
            <div class="text-xs text-slate-500 mt-2">Pay</div>
            <div class="mt-1" id="mPayBadge">-</div>
            <div class="text-xs text-slate-500 mt-2">Gross</div>
            <div class="font-extrabold mt-1" id="mGross">-</div>
          </div>

          <div class="card soft card-pad" style="border-radius:18px;border:1px solid var(--line2);">
            <div class="label">Fulfill Status</div>
            <select id="mFulfill" class="select">
              <option value="waiting">waiting</option>
              <option value="processing">processing</option>
              <option value="done">done</option>
              <option value="rejected">rejected</option>
            </select>

            <div class="label mt-3">Admin Note</div>
            <textarea id="mNote" class="textarea" rows="4" placeholder="Catatan untuk customer (dipakai di template WA)"></textarea>

            <div class="mt-3">
              <button class="btn btn-primary shimmer btn-block" id="saveBtn">
                <i class="ri-save-3-line"></i> Simpan
              </button>
            </div>
          </div>
        </div>

        <div class="mt-3 help">
          Saran: set “processing” saat mulai pengerjaan. “done”/“rejected” akan memicu template WA (jika enabled + connected).
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function rupiah(n){ return 'Rp ' + (Number(n||0)).toLocaleString('id-ID'); }

  function escapeHtml(s){
    return String(s || '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }
  function escapeAttr(s){
    return String(s || '')
      .replaceAll('&','&amp;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;');
  }

  function payBadge(st){
    st = String(st||'').toLowerCase();
    if(st === 'settlement' || st === 'capture') return '<span class="badge good"><i class="ri-check-line"></i> ' + escapeHtml(st) + '</span>';
    if(st === 'pending') return '<span class="badge warn"><i class="ri-time-line"></i> pending</span>';
    if(st === 'expire' || st === 'cancel' || st === 'deny' || st === 'failure')
      return '<span class="badge bad"><i class="ri-close-line"></i> ' + escapeHtml(st) + '</span>';
    return '<span class="badge"><i class="ri-question-line"></i> ' + escapeHtml(st || '-') + '</span>';
  }
  function fulfillBadge(st){
    st = String(st||'').toLowerCase();
    if(st === 'done') return '<span class="badge good"><i class="ri-check-double-line"></i> done</span>';
    if(st === 'processing') return '<span class="badge info"><i class="ri-loader-4-line"></i> processing</span>';
    if(st === 'waiting') return '<span class="badge warn"><i class="ri-hourglass-2-line"></i> waiting</span>';
    if(st === 'rejected') return '<span class="badge bad"><i class="ri-close-line"></i> rejected</span>';
    return '<span class="badge">' + escapeHtml(st||'-') + '</span>';
  }

  let CURRENT = null;
  let DATA = [];

  function rowHtml(o){
    const note = escapeAttr(o.admin_note || '');
    return `
      <tr>
        <td>
          <div class="td-strong">${escapeHtml(o.order_id)}</div>
          <div class="td-muted" style="font-size:12px;">${escapeHtml(String(o.created_at).replace('T',' ').slice(0,19))}</div>
        </td>
        <td>
          <div class="td-strong">${escapeHtml(o.product_name)}</div>
          <div class="td-muted" style="font-size:12px;">qty: ${Number(o.qty||0)} • unit: ${rupiah(o.unit_price||0)}</div>
        </td>
        <td>
          <div class="td-strong">${escapeHtml(o.game_id)}</div>
          <div class="td-muted" style="font-size:12px;">${escapeHtml(o.nickname || '-')} • ${escapeHtml(o.whatsapp || '-')}</div>
        </td>
        <td><div class="td-strong">${rupiah(o.gross_amount)}</div></td>
        <td>${payBadge(o.pay_status)}</td>
        <td>${fulfillBadge(o.fulfill_status)}</td>
        <td class="td-actions">
          <button class="btn btn-sm js-edit"
            data-oid="${escapeAttr(o.order_id)}"
            data-pay="${escapeAttr(o.pay_status)}"
            data-ful="${escapeAttr(o.fulfill_status)}"
            data-note="${note}"
            data-gross="${escapeAttr(String(o.gross_amount||0))}">
            <i class="ri-pencil-line"></i> Edit
          </button>
        </td>
      </tr>
    `;
  }

  function cardHtml(o){
    const note = escapeAttr(o.admin_note || '');
    return `
      <div class="card soft" style="border-radius:22px;border:1px solid var(--line2);padding:12px;margin-bottom:12px;">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="td-strong truncate">${escapeHtml(o.order_id)}</div>
            <div class="td-muted" style="font-size:12px;margin-top:4px;">${escapeHtml(String(o.created_at).replace('T',' ').slice(0,19))}</div>
          </div>
          <button class="btn btn-sm js-edit"
            data-oid="${escapeAttr(o.order_id)}"
            data-pay="${escapeAttr(o.pay_status)}"
            data-ful="${escapeAttr(o.fulfill_status)}"
            data-note="${note}"
            data-gross="${escapeAttr(String(o.gross_amount||0))}">
            <i class="ri-pencil-line"></i>
          </button>
        </div>

        <div class="mt-3">
          <div class="text-sm font-extrabold">${escapeHtml(o.product_name)}</div>
          <div class="td-muted" style="font-size:12px;">
            qty ${Number(o.qty||0)} • unit ${rupiah(o.unit_price||0)} • total <b>${rupiah(o.gross_amount||0)}</b>
          </div>
        </div>

        <div class="mt-3 grid grid-cols-2 gap-2">
          <div class="card soft" style="border-radius:18px;border:1px solid var(--line2);padding:10px;">
            <div class="td-muted" style="font-size:12px;">Customer</div>
            <div class="td-strong truncate">${escapeHtml(o.game_id)}</div>
            <div class="td-muted truncate" style="font-size:12px;">${escapeHtml(o.nickname || '-')} • ${escapeHtml(o.whatsapp || '-')}</div>
          </div>
          <div class="card soft" style="border-radius:18px;border:1px solid var(--line2);padding:10px;">
            <div class="td-muted" style="font-size:12px;">Status</div>
            <div class="mt-1">${payBadge(o.pay_status)}</div>
            <div class="mt-2">${fulfillBadge(o.fulfill_status)}</div>
          </div>
        </div>
      </div>
    `;
  }

  function openModalFromData(data){
    CURRENT = data.oid;
    $('#mOrderId').text(CURRENT);
    $('#mFulfill').val(data.ful || 'waiting');
    $('#mNote').val(data.note || '');
    $('#mPayBadge').html(payBadge(data.pay || '-'));
    $('#mGross').text(rupiah(data.gross || 0));

    $('body').addClass('modal-open');
    $('#modal').removeClass('hidden');
  }

  function closeModal(){
    $('#modal').addClass('hidden');
    $('body').removeClass('modal-open');
    CURRENT = null;
  }

  function renderResponsive(data){
    const isMobile = window.matchMedia && window.matchMedia('(max-width: 880px)').matches;
    if(isMobile){
      $('#tableWrap').hide();
      $('#cardsWrap').show();
      $('#countBox2').text(data.length);
      $('#cardsBox').html(data.map(cardHtml).join('') || `<div class="text-slate-500 text-sm">No data</div>`);
    } else {
      $('#cardsWrap').hide();
      $('#tableWrap').show();
      $('#countBox').text(data.length);
      $('#tbody').html(data.map(rowHtml).join('') || `<tr><td colspan="7" style="padding:12px;color:#64748b;">No data</td></tr>`);
    }
  }

  async function load(){
    const qs = $.param({
      q: $('#q').val(),
      pay_status: $('#pay_status').val(),
      fulfill_status: $('#fulfill_status').val()
    });

    $('#cardsBox').html(RD.ui.skeletonBlocks ? RD.ui.skeletonBlocks(6) : '');
    if (RD.ui.skeletonTableRows) RD.ui.skeletonTableRows('#tbody', 7, 7);

    try {
      const resp = await $.ajax({
        method:'GET',
        url: window.__ADMIN_BASE + '/api/orders?' + qs
      });
      if (!resp.ok) throw new Error(resp.message || 'Failed');
      DATA = resp.data || [];
      renderResponsive(DATA);
    } catch(e) {
      toastr.error(e.message || 'Failed load orders');
    }
  }

  $('#btnRefresh').on('click', load);

  $('#btnQuickPending').on('click', function(){
    $('#pay_status').val('pending'); $('#fulfill_status').val('');
    load();
  });

  $('#btnQuickWaiting').on('click', function(){
    $('#fulfill_status').val('waiting'); $('#pay_status').val('');
    load();
  });

  $('#q').on('keyup', RD.util.debounce(load, 400));
  $('#pay_status, #fulfill_status').on('change', load);

  $(document).off('click.orders', '.js-edit').on('click.orders', '.js-edit', function(){
    openModalFromData({
      oid: String($(this).data('oid') || ''),
      pay: String($(this).data('pay') || ''),
      ful: String($(this).data('ful') || ''),
      note: String($(this).data('note') || ''),
      gross: String($(this).data('gross') || '0')
    });
  });

  $(document).off('click.orders', '#closeModal').on('click.orders', '#closeModal', closeModal);
  $(document).off('click.orders', '#modal').on('click.orders', '#modal', function(e){
    if (e.target.id === 'modal') closeModal();
  });

  $(document).off('keydown.orders').on('keydown.orders', function(e){
    if (e.key === 'Escape' && !$('#modal').hasClass('hidden')) closeModal();
  });

  $(document).off('click.orders', '#saveBtn').on('click.orders', '#saveBtn', async function(){
    if (!CURRENT) return;
    RD.ui.overlay(true);
    try {
      const resp = await $.ajax({
        method:'POST',
        url: window.__ADMIN_BASE + '/api/orders/' + encodeURIComponent(CURRENT) + '/fulfill',
        data: {
          fulfill_status: $('#mFulfill').val(),
          admin_note: $('#mNote').val()
        }
      });
      if (!resp.ok) throw new Error(resp.message || 'Failed');
      toastr.success('Saved');
      closeModal();
      load();
    } catch(e) {
      toastr.error(e.responseJSON?.message || e.message || 'Failed');
    } finally {
      RD.ui.overlay(false);
    }
  });

  const onResize = RD.util.debounce(() => renderResponsive(DATA || []), 120);
  window.addEventListener('resize', onResize);

  RD.router.onLeave(() => {
    window.removeEventListener('resize', onResize);
    $(document).off('.orders');
    closeModal();
  });

  load();
</script>
