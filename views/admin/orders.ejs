<div class="fade-up">
  <div class="card card-pad scanline">
    <div class="card-row">
      <div class="min-w-0">
        <div class="pill"><i class="ri-file-list-3-line"></i> Management</div>
        <div class="card-title mt-2">Orders</div>
        <div class="card-sub">Filter, cari, dan update fulfill status + catatan admin.</div>
      </div>

      <div class="flex gap-2 flex-wrap">
        <button class="btn btn-ghost" id="btnRefresh"><i class="ri-refresh-line"></i> Refresh</button>
        <button class="btn btn-primary shimmer" id="btnQuickPending">
          <i class="ri-time-line"></i> Pending
        </button>
        <button class="btn btn-primary shimmer" id="btnQuickWaiting">
          <i class="ri-hourglass-2-line"></i> Waiting
        </button>
      </div>
    </div>

    <div class="mt-4 form-grid">
      <div class="col-6">
        <div class="label">Search</div>
        <input id="q" class="input" placeholder="order_id / game_id / wa / product" />
      </div>

      <div class="col-3">
        <div class="label">Pay Status</div>
        <select id="pay_status" class="select">
          <option value="">all</option>
          <option>pending</option>
          <option>settlement</option>
          <option>capture</option>
          <option>expire</option>
          <option>cancel</option>
          <option>deny</option>
          <option>failure</option>
        </select>
      </div>

      <div class="col-3">
        <div class="label">Fulfill</div>
        <select id="fulfill_status" class="select">
          <option value="">all</option>
          <option value="waiting">waiting</option>
          <option value="processing">processing</option>
          <option value="done">done</option>
          <option value="rejected">rejected</option>
        </select>
      </div>

      <div class="col-12">
        <div class="help">
          Tip: gunakan quick filter “Pending” untuk cek pembayaran, dan “Waiting” untuk antrian proses.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- LIST WRAP (pagination lives here) -->
<div class="mt-4 card card-pad fade-up">
  <div class="card-row">
    <div class="font-extrabold text-lg">Orders</div>
    <div class="flex items-center gap-2 flex-wrap">
      <div class="pill"><i class="ri-database-2-line"></i> <span id="countBox">0</span> total</div>
      <div class="pill"><i class="ri-pages-line"></i> page <span id="pageNow">1</span>/<span id="pageTotal">1</span></div>
    </div>
  </div>

  <!-- DESKTOP TABLE -->
  <div class="mt-4" id="tableWrap">
    <div style="overflow:auto;">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left text-slate-500">
            <th class="py-2 pr-3">Order</th>
            <th class="py-2 pr-3">Produk</th>
            <th class="py-2 pr-3">Customer</th>
            <th class="py-2 pr-3">Amount</th>
            <th class="py-2 pr-3">Pay</th>
            <th class="py-2 pr-3">Fulfill</th>
            <th class="py-2 pr-3 text-right">Action</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- MOBILE CARDS -->
  <div class="mt-4" id="cardsWrap" style="display:none;">
    <div id="cardsBox"></div>
  </div>

  <!-- PAGINATION -->
  <div class="mt-4 flex items-center justify-between gap-2 flex-wrap">
    <div class="text-xs text-slate-500">
      Menampilkan <b id="rangeText">0-0</b> dari <b id="totalText">0</b> data • per halaman <b>5</b>
    </div>

    <div class="flex items-center gap-2 flex-wrap">
      <button class="btn btn-ghost btn-sm" id="btnPrev"><i class="ri-arrow-left-line"></i> Prev</button>
      <div id="pageBtns" class="flex items-center gap-2 flex-wrap"></div>
      <button class="btn btn-ghost btn-sm" id="btnNext">Next <i class="ri-arrow-right-line"></i></button>
    </div>
  </div>
</div>

<!-- MODAL -->
<div id="modal" class="hidden fixed inset-0 z-50 bg-black/30 backdrop-blur-sm">
  <div class="rd-modal-wrap">
    <div class="rd-modal-card card card-pad" style="width:100%;max-width:680px;">
      <div class="card-row">
        <div>
          <div class="font-extrabold text-lg">Update Fulfill</div>
          <div class="text-sm text-slate-500">Update status + admin note (dipakai template WA).</div>
        </div>
        <button class="btn btn-ghost" id="closeModal"><i class="ri-close-line"></i></button>
      </div>

      <div class="mt-4 grid md:grid-cols-2 gap-3">
        <div class="card soft card-pad" style="border-radius:18px;border:1px solid var(--line2);">
          <div class="text-xs text-slate-500">Order ID</div>
          <div class="font-extrabold mt-1" id="mOrderId">-</div>
          <div class="text-xs text-slate-500 mt-2">Pay</div>
          <div class="mt-1" id="mPayBadge">-</div>
          <div class="text-xs text-slate-500 mt-2">Gross</div>
          <div class="font-extrabold mt-1" id="mGross">-</div>
        </div>

        <div class="card soft card-pad" style="border-radius:18px;border:1px solid var(--line2);">
          <div class="label">Fulfill Status</div>
          <select id="mFulfill" class="select">
            <option value="waiting">waiting</option>
            <option value="processing">processing</option>
            <option value="done">done</option>
            <option value="rejected">rejected</option>
          </select>

          <div class="label mt-3">Admin Note</div>
          <textarea id="mNote" class="textarea" rows="4" placeholder="Catatan untuk customer (dipakai di template WA)"></textarea>

          <div class="mt-3">
            <button class="btn btn-primary shimmer btn-block" id="saveBtn">
              <i class="ri-save-3-line"></i> Simpan
            </button>
          </div>
        </div>
      </div>

      <div class="mt-3 help">
        Saran: set “processing” saat mulai pengerjaan. “done”/“rejected” akan memicu template WA (jika enabled + connected).
      </div>
    </div>
  </div>
</div>

<script>
  function rupiah(n){ return 'Rp ' + (Number(n||0)).toLocaleString('id-ID'); }

  function escapeHtml(s){
    return String(s || '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  function payBadge(st){
    st = String(st||'').toLowerCase();
    if(st === 'settlement' || st === 'capture') return `<span class="badge good"><i class="ri-check-line"></i> ${st}</span>`;
    if(st === 'pending') return `<span class="badge warn"><i class="ri-time-line"></i> ${st}</span>`;
    if(st === 'expire' || st === 'cancel' || st === 'deny' || st === 'failure') return `<span class="badge bad"><i class="ri-close-line"></i> ${st}</span>`;
    return `<span class="badge"><i class="ri-question-line"></i> ${escapeHtml(st || '-')}</span>`;
  }

  function fulfillBadge(st){
    st = String(st||'').toLowerCase();
    if(st === 'done') return `<span class="badge good"><i class="ri-check-double-line"></i> done</span>`;
    if(st === 'processing') return `<span class="badge info"><i class="ri-loader-4-line"></i> processing</span>`;
    if(st === 'waiting') return `<span class="badge warn"><i class="ri-hourglass-2-line"></i> waiting</span>`;
    if(st === 'rejected') return `<span class="badge bad"><i class="ri-close-line"></i> rejected</span>`;
    return `<span class="badge">${escapeHtml(st||'-')}</span>`;
  }

  const PAGE_SIZE = 5;
  let CURRENT = null;
  let DATA = [];
  let PAGE = 1;

  function rowHtml(o){
    const note = escapeHtml(o.admin_note || '');
    return `
      <tr class="border-t">
        <td class="py-2 pr-3">
          <div class="font-extrabold">${escapeHtml(o.order_id)}</div>
          <div class="text-xs text-slate-500">${escapeHtml(String(o.created_at).replace('T',' ').slice(0,19))}</div>
        </td>
        <td class="py-2 pr-3">
          <div class="font-extrabold">${escapeHtml(o.product_name)}</div>
          <div class="text-xs text-slate-500">qty: ${Number(o.qty||0)} • unit: ${rupiah(o.unit_price||0)}</div>
        </td>
        <td class="py-2 pr-3">
          <div class="font-extrabold">${escapeHtml(o.game_id)}</div>
          <div class="text-xs text-slate-500">${escapeHtml(o.nickname || '-')} • ${escapeHtml(o.whatsapp || '-')}</div>
        </td>
        <td class="py-2 pr-3">
          <div class="font-extrabold">${rupiah(o.gross_amount)}</div>
        </td>
        <td class="py-2 pr-3">${payBadge(o.pay_status)}</td>
        <td class="py-2 pr-3">${fulfillBadge(o.fulfill_status)}</td>
        <td class="py-2 pr-3 text-right">
          <button class="btn btn-sm js-edit"
            data-oid="${escapeHtml(o.order_id)}"
            data-pay="${escapeHtml(o.pay_status)}"
            data-ful="${escapeHtml(o.fulfill_status)}"
            data-note="${note}"
            data-gross="${escapeHtml(String(o.gross_amount||0))}">
            <i class="ri-pencil-line"></i> Edit
          </button>
        </td>
      </tr>
    `;
  }

  function cardHtml(o){
    const note = escapeHtml(o.admin_note || '');
    return `
      <div class="card soft" style="border-radius:22px;border:1px solid var(--line2);padding:12px;margin-bottom:12px;">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="font-extrabold truncate">${escapeHtml(o.order_id)}</div>
            <div class="text-xs text-slate-500 mt-1">${escapeHtml(String(o.created_at).replace('T',' ').slice(0,19))}</div>
          </div>
          <button class="btn btn-sm js-edit"
            data-oid="${escapeHtml(o.order_id)}"
            data-pay="${escapeHtml(o.pay_status)}"
            data-ful="${escapeHtml(o.fulfill_status)}"
            data-note="${note}"
            data-gross="${escapeHtml(String(o.gross_amount||0))}">
            <i class="ri-pencil-line"></i>
          </button>
        </div>

        <div class="mt-3">
          <div class="text-sm font-extrabold">${escapeHtml(o.product_name)}</div>
          <div class="text-xs text-slate-500">qty ${Number(o.qty||0)} • unit ${rupiah(o.unit_price||0)} • total <b>${rupiah(o.gross_amount||0)}</b></div>
        </div>

        <div class="mt-3 grid grid-cols-2 gap-2">
          <div class="card soft" style="border-radius:18px;border:1px solid var(--line2);padding:10px;">
            <div class="text-xs text-slate-500">Customer</div>
            <div class="font-extrabold truncate">${escapeHtml(o.game_id)}</div>
            <div class="text-xs text-slate-500 truncate">${escapeHtml(o.nickname || '-')} • ${escapeHtml(o.whatsapp || '-')}</div>
          </div>
          <div class="card soft" style="border-radius:18px;border:1px solid var(--line2);padding:10px;">
            <div class="text-xs text-slate-500">Status</div>
            <div class="mt-1">${payBadge(o.pay_status)}</div>
            <div class="mt-2">${fulfillBadge(o.fulfill_status)}</div>
          </div>
        </div>
      </div>
    `;
  }

  function openModalFromData(data){
    CURRENT = data.oid;
    $('#mOrderId').text(CURRENT);
    $('#mFulfill').val(data.ful || 'waiting');
    $('#mNote').val(data.note || '');
    $('#mPayBadge').html(payBadge(data.pay || '-'));
    $('#mGross').text(rupiah(data.gross || 0));
    $('body').addClass('modal-open');
    $('#modal').removeClass('hidden');
  }

  function closeModal(){
    $('#modal').addClass('hidden');
    $('body').removeClass('modal-open');
    CURRENT = null;
  }

  function totalPages(){
    return Math.max(1, Math.ceil((DATA || []).length / PAGE_SIZE));
  }

  function sliceForPage(p){
    const start = (p - 1) * PAGE_SIZE;
    return (DATA || []).slice(start, start + PAGE_SIZE);
  }

  function renderPagination(){
    const tp = totalPages();
    PAGE = Math.min(Math.max(1, PAGE), tp);

    $('#pageNow').text(PAGE);
    $('#pageTotal').text(tp);
    $('#totalText').text(DATA.length);

    const start = DATA.length ? ((PAGE-1)*PAGE_SIZE + 1) : 0;
    const end = Math.min(PAGE*PAGE_SIZE, DATA.length);
    $('#rangeText').text(`${start}-${end}`);
    $('#countBox').text(DATA.length);

    $('#btnPrev').prop('disabled', PAGE <= 1).toggleClass('opacity-60', PAGE<=1);
    $('#btnNext').prop('disabled', PAGE >= tp).toggleClass('opacity-60', PAGE>=tp);

    // Page number buttons (max 5)
    const maxBtns = 5;
    let from = Math.max(1, PAGE - 2);
    let to = Math.min(tp, from + (maxBtns - 1));
    from = Math.max(1, to - (maxBtns - 1));

    let html = '';
    for(let i = from; i <= to; i++){
      const active = i === PAGE;
      html += `
        <button class="btn btn-sm ${active ? 'btn-primary' : 'btn-ghost'} js-page" data-page="${i}">
          ${i}
        </button>
      `;
    }
    $('#pageBtns').html(html);
  }

  function renderResponsivePage(){
    const isMobile = window.matchMedia && window.matchMedia('(max-width: 880px)').matches;
    const pageData = sliceForPage(PAGE);

    if(isMobile){
      $('#tableWrap').hide();
      $('#cardsWrap').show();
      $('#cardsBox').html(pageData.map(cardHtml).join('') || `<div class="text-slate-500 text-sm">No data</div>`);
    } else {
      $('#cardsWrap').hide();
      $('#tableWrap').show();
      $('#tbody').html(pageData.map(rowHtml).join('') || `<tr><td class="py-3 text-slate-500" colspan="7">No data</td></tr>`);
    }

    renderPagination();
  }

  async function load(resetPage=true){
    const qs = $.param({
      q: $('#q').val(),
      pay_status: $('#pay_status').val(),
      fulfill_status: $('#fulfill_status').val()
    });

    // skeleton
    $('#cardsBox').html(RD.ui.skeletonBlocks ? RD.ui.skeletonBlocks(5) : '');
    if (RD.ui.skeletonTableRows) RD.ui.skeletonTableRows('#tbody', 7, 5);

    try {
      const resp = await $.ajax({
        method:'GET',
        url: window.__ADMIN_BASE + '/api/orders?' + qs,
        headers: { 'X-CSRF-Token': window.__CSRF_TOKEN }
      });
      if (!resp.ok) throw new Error('Failed');

      DATA = resp.data || [];
      if (resetPage) PAGE = 1;
      renderResponsivePage();

    } catch(e) {
      toastr.error(e.message || 'Failed load orders');
      $('#tbody').html(`<tr><td class="py-3 text-rose-600" colspan="7">Error</td></tr>`);
      $('#cardsBox').html(`<div class="text-rose-600 text-sm">Error</div>`);
      DATA = [];
      PAGE = 1;
      renderPagination();
    }
  }

  // events
  $('#btnRefresh').on('click', () => load(true));

  $('#btnQuickPending').on('click', function(){
    $('#pay_status').val('pending');
    $('#fulfill_status').val('');
    load(true);
  });

  $('#btnQuickWaiting').on('click', function(){
    $('#fulfill_status').val('waiting');
    $('#pay_status').val('');
    load(true);
  });

  $('#q').on('keyup', RD.util.debounce(() => load(true), 400));
  $('#pay_status, #fulfill_status').on('change', () => load(true));

  // pagination controls
  $(document).on('click', '#btnPrev', function(){
    PAGE = Math.max(1, PAGE - 1);
    renderResponsivePage();
  });
  $(document).on('click', '#btnNext', function(){
    PAGE = Math.min(totalPages(), PAGE + 1);
    renderResponsivePage();
  });
  $(document).on('click', '.js-page', function(){
    PAGE = Number($(this).data('page') || 1);
    renderResponsivePage();
  });

  // delegated edit (works for table + cards)
  $(document).off('click', '.js-edit').on('click', '.js-edit', function(){
    const data = {
      oid: String($(this).data('oid') || ''),
      pay: String($(this).data('pay') || ''),
      ful: String($(this).data('ful') || ''),
      note: String($(this).data('note') || ''),
      gross: String($(this).data('gross') || '0')
    };
    openModalFromData(data);
  });

  $('#closeModal').on('click', closeModal);
  $('#modal').on('click', (e) => { if (e.target.id==='modal') closeModal(); });

  // ESC close
  $(document).on('keydown', function(e){
    if (e.key === 'Escape' && !$('#modal').hasClass('hidden')) closeModal();
  });

  $('#saveBtn').on('click', async function(){
    if (!CURRENT) return;
    RD.ui.overlay(true);
    try {
      const resp = await $.ajax({
        method:'POST',
        url: window.__ADMIN_BASE + '/api/orders/' + encodeURIComponent(CURRENT) + '/fulfill',
        data: {
          fulfill_status: $('#mFulfill').val(),
          admin_note: $('#mNote').val()
        },
        headers: { 'X-CSRF-Token': window.__CSRF_TOKEN }
      });
      if (!resp.ok) throw new Error(resp.message || 'Failed');
      toastr.success('Saved');
      closeModal();
      load(false); // keep page if possible
    } catch(e) {
      toastr.error(e.responseJSON?.message || e.message || 'Failed');
    } finally {
      RD.ui.overlay(false);
    }
  });

  // rerender on resize (for responsive switch)
  const onResize = RD.util.debounce(function(){
    renderResponsivePage();
  }, 120);
  window.addEventListener('resize', onResize);
  RD.router.onLeave(() => window.removeEventListener('resize', onResize));

  load(true);
</script>
