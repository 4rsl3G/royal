<div class="fade-up">
  <div class="card card-pad scanline">
    <div class="card-row">
      <div class="min-w-0">
        <div class="pill"><i class="ri-store-2-line"></i> Catalog</div>
        <div class="card-title mt-2">Products</div>
        <div class="card-sub">CRUD produk + upload image (max 2MB). Search + pagination custom.</div>
      </div>
      <div class="flex gap-2 flex-wrap">
        <button class="btn btn-ghost" id="reloadBtnTop"><i class="ri-refresh-line"></i> Reload</button>
        <button class="btn btn-primary shimmer" id="resetBtnTop"><i class="ri-add-line"></i> New Product</button>
      </div>
    </div>
  </div>
</div>

<div class="mt-4 grid lg:grid-cols-2 gap-4">
  <!-- FORM -->
  <form id="productForm" class="card card-pad fade-up" enctype="multipart/form-data">
    <div class="card-row">
      <div>
        <div class="font-extrabold text-lg" id="formTitle">Create Product</div>
        <div class="text-sm text-slate-500" id="formHint">Isi data lalu klik Save.</div>
      </div>
      <span class="badge info" id="modeBadge"><i class="ri-add-circle-line"></i> create</span>
    </div>

    <input type="hidden" name="id" id="pid" />

    <div class="mt-4 form-grid">
      <div class="col-6">
        <div class="label">SKU</div>
        <input name="sku" id="sku" class="input" required placeholder="RD-CHIP-100" />
      </div>

      <div class="col-6">
        <div class="label">Sort Order</div>
        <input name="sort_order" id="sort_order" type="number" class="input" value="0" />
        <div class="help">Semakin kecil → semakin atas.</div>
      </div>

      <div class="col-12">
        <div class="label">Name</div>
        <input name="name" id="name" class="input" required placeholder="Chip 100.000" />
      </div>

      <div class="col-12">
        <div class="label">Game Name</div>
        <input name="game_name" id="game_name" class="input" value="Royal Dreams" />
      </div>

      <div class="col-6">
        <div class="label">Price Type</div>
        <select name="price_type" id="price_type" class="select">
          <option value="fixed">fixed</option>
          <option value="per_item">per_item</option>
        </select>
        <div class="help">fixed = qty dipaksa 1. per_item = qty menentukan total.</div>
      </div>

      <div class="col-6">
        <div class="label">Active</div>
        <select name="active" id="active" class="select">
          <option value="1">1 (active)</option>
          <option value="0">0 (inactive)</option>
        </select>
      </div>

      <div class="col-6">
        <div class="label">Price (fixed)</div>
        <input name="price" id="price" type="number" class="input" value="0" />
      </div>

      <div class="col-6">
        <div class="label">Price per item</div>
        <input name="price_per_item" id="price_per_item" type="number" class="input" value="0" />
      </div>

      <div class="col-12">
        <div class="label">Image</div>
        <div class="card soft card-pad" style="border-radius:18px;border:1px solid var(--line2);">
          <div class="flex items-center gap-3 flex-wrap">
            <div id="imgPreview" class="scanline" style="width:72px;height:72px;border-radius:20px;border:1px solid var(--line);background:rgba(255,255,255,.8);display:flex;align-items:center;justify-content:center;overflow:hidden;">
              <i class="ri-image-line" style="font-size:26px;color:rgba(100,116,139,.9)"></i>
            </div>
            <div style="flex:1;min-width:220px;">
              <input name="image" id="image" type="file" accept="image/png,image/jpeg,image/jpg,image/webp" class="input" />
              <div class="help">Max 2MB (png/jpg/jpeg/webp). Upload hanya jika mau ganti.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 flex gap-2 flex-wrap">
        <button class="btn btn-primary shimmer btn-block" type="submit">
          <i class="ri-save-3-line"></i> Save
        </button>

        <button class="btn btn-ghost" type="button" id="resetBtn">
          <i class="ri-refresh-line"></i> Reset
        </button>

        <button class="btn btn-danger" type="button" id="cancelEditBtn" style="display:none;">
          <i class="ri-close-circle-line"></i> Cancel Edit
        </button>
      </div>
    </div>
  </form>

  <!-- LIST -->
  <div class="card card-pad fade-up">
    <div class="card-row">
      <div>
        <div class="font-extrabold text-lg">Product List</div>
        <div class="text-sm text-slate-500">Search + pagination custom. Klik Edit untuk muat ke form.</div>
      </div>
      <div class="flex gap-2 flex-wrap items-center">
        <button class="btn btn-ghost" id="reloadBtn"><i class="ri-refresh-line"></i></button>
        <div class="pill"><i class="ri-box-3-line"></i> <span id="countBox">0</span> items</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="mt-4 form-grid">
      <div class="col-6">
        <div class="label">Search</div>
        <input id="pSearch" class="input" placeholder="Cari: sku / name / game…" />
      </div>
      <div class="col-3">
        <div class="label">Per Page</div>
        <select id="pPerPage" class="select">
          <option value="6">6</option>
          <option value="8" selected>8</option>
          <option value="10">10</option>
          <option value="15">15</option>
        </select>
      </div>
      <div class="col-3">
        <div class="label">Sort</div>
        <select id="pSort" class="select">
          <option value="sort_order:asc">sort_order (asc)</option>
          <option value="sort_order:desc">sort_order (desc)</option>
          <option value="name:asc">name (asc)</option>
          <option value="name:desc">name (desc)</option>
          <option value="price:asc">price (asc)</option>
          <option value="price:desc">price (desc)</option>
          <option value="created_at:desc">created (desc)</option>
          <option value="created_at:asc">created (asc)</option>
        </select>
      </div>

      <div class="col-12">
        <div class="help">Tip: di mobile akan tampil card list. Di desktop tampil table.</div>
      </div>
    </div>

    <!-- DESKTOP TABLE -->
    <div class="mt-4 rd-only-desktop">
      <div class="table-wrap">
        <div class="rd-scroll" style="max-height:var(--scrollH);">
          <table class="table" style="min-width:980px;">
            <thead>
              <tr>
                <th style="width:76px;">IMG</th>
                <th>PRODUCT</th>
                <th style="width:110px;">TYPE</th>
                <th style="width:140px;">PRICE</th>
                <th style="width:110px;">STATUS</th>
                <th style="width:90px;">SORT</th>
                <th style="width:170px;text-align:right;">ACTION</th>
              </tr>
            </thead>
            <tbody id="pTbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- MOBILE CARDS -->
    <div class="mt-4 rd-only-mobile">
      <div id="pCards"></div>
    </div>

    <!-- Pager -->
    <div class="mt-4 rd-pager">
      <button class="btn btn-ghost btn-block" id="pPrev"><i class="ri-arrow-left-line"></i> Prev</button>
      <div class="rd-pager-info">
        <div class="font-extrabold" id="pPageLabel">Page 1 / 1</div>
        <div class="text-xs text-slate-500" id="pInfo">Menampilkan 0 dari 0.</div>
      </div>
      <button class="btn btn-ghost btn-block" id="pNext">Next <i class="ri-arrow-right-line"></i></button>
    </div>
  </div>
</div>

<script>
  function rupiah(n){ return 'Rp ' + (Number(n||0)).toLocaleString('id-ID'); }
  function escapeHtml(s){
    return String(s || '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  let DATA = [];
  let CURRENT_IMAGE = null;

  const STATE = {
    q: '',
    page: 1,
    perPage: 8,
    sortKey: 'sort_order',
    sortDir: 'asc'
  };

  function setMode(mode){
    if(mode === 'edit'){
      $('#modeBadge').removeClass('info').addClass('warn').html('<i class="ri-pencil-line"></i> edit');
      $('#formTitle').text('Edit Product');
      $('#formHint').text('Ubah data lalu klik Save. Upload image hanya jika mau ganti.');
      $('#cancelEditBtn').show();
    } else {
      $('#modeBadge').removeClass('warn').addClass('info').html('<i class="ri-add-circle-line"></i> create');
      $('#formTitle').text('Create Product');
      $('#formHint').text('Isi data lalu klik Save.');
      $('#cancelEditBtn').hide();
    }
  }

  function resetForm(){
    CURRENT_IMAGE = null;
    $('#pid').val('');
    $('#productForm')[0].reset();
    $('#game_name').val('Royal Dreams');
    $('#price').val(0);
    $('#price_per_item').val(0);
    $('#sort_order').val(0);
    $('#active').val('1');
    $('#price_type').val('fixed');
    $('#image').val('');
    $('#imgPreview').html('<i class="ri-image-line" style="font-size:26px;color:rgba(100,116,139,.9)"></i>');
    setMode('create');
    applyPriceTypeRules();
  }

  function applyPriceTypeRules(){
    const t = $('#price_type').val();
    if(t === 'fixed'){
      $('#price').prop('disabled', false);
      $('#price_per_item').prop('disabled', true).val(0);
    } else {
      $('#price').prop('disabled', true).val(0);
      $('#price_per_item').prop('disabled', false);
    }
  }

  function statusBadge(active){
    const ok = String(active) === '1';
    return ok
      ? `<span class="badge good"><i class="ri-check-line"></i> active</span>`
      : `<span class="badge bad"><i class="ri-close-line"></i> inactive</span>`;
  }

  function typeBadge(t){
    t = String(t || '').toLowerCase();
    if(t === 'fixed') return `<span class="badge info"><i class="ri-price-tag-3-line"></i> fixed</span>`;
    return `<span class="badge warn"><i class="ri-price-tag-3-line"></i> per_item</span>`;
  }

  function priceText(p){
    return (String(p.price_type) === 'fixed')
      ? rupiah(p.price)
      : (rupiah(p.price_per_item) + ' /item');
  }

  function imgCell(p){
    if (p.image) {
      return `<img src="${p.image}" style="width:54px;height:54px;border-radius:18px;object-fit:cover;border:1px solid var(--line);" />`;
    }
    return `<div style="width:54px;height:54px;border-radius:18px;border:1px solid var(--line);background:rgba(255,255,255,.8);display:flex;align-items:center;justify-content:center;">
      <i class="ri-image-line" style="font-size:22px;color:rgba(100,116,139,.9)"></i>
    </div>`;
  }

  function rowHtml(p){
    return `
      <tr>
        <td>${imgCell(p)}</td>
        <td>
          <div class="td-strong break-anywhere">${escapeHtml(p.name)}</div>
          <div class="td-muted" style="font-size:12px;margin-top:4px;">
            <b>${escapeHtml(p.sku)}</b> • ${escapeHtml(p.game_name || 'Royal Dreams')}
          </div>
        </td>
        <td>${typeBadge(p.price_type)}</td>
        <td><div class="td-strong">${priceText(p)}</div></td>
        <td>${statusBadge(p.active)}</td>
        <td><span class="badge"><i class="ri-sort-asc"></i> ${Number(p.sort_order||0)}</span></td>
        <td class="td-actions">
          <button class="btn btn-sm js-edit" data-id="${p.id}"><i class="ri-pencil-line"></i> Edit</button>
          <button class="btn btn-sm btn-danger js-del" data-id="${p.id}" title="Delete"><i class="ri-delete-bin-6-line"></i></button>
        </td>
      </tr>
    `;
  }

  function cardHtml(p){
    return `
      <div class="rd-order-card" style="padding:14px;">
        <div class="rd-order-top">
          <div class="min-w-0" style="display:flex;gap:10px;align-items:flex-start;">
            <div>${imgCell(p)}</div>
            <div class="min-w-0">
              <div class="rd-order-id">${escapeHtml(p.name)}</div>
              <div class="rd-order-time"><b>${escapeHtml(p.sku)}</b> • ${escapeHtml(p.game_name || 'Royal Dreams')}</div>
              <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                ${typeBadge(p.price_type)}
                ${statusBadge(p.active)}
                <span class="badge"><i class="ri-sort-asc"></i> ${Number(p.sort_order||0)}</span>
              </div>
              <div style="margin-top:10px;font-weight:900;">${priceText(p)}</div>
            </div>
          </div>

          <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end;">
            <button class="btn btn-sm js-edit" data-id="${p.id}">
              <i class="ri-pencil-line"></i> Edit
            </button>
            <button class="btn btn-sm btn-danger js-del" data-id="${p.id}">
              <i class="ri-delete-bin-6-line"></i>
            </button>
          </div>
        </div>
      </div>
    `;
  }

  function cmp(a, b){
    if (a == null && b == null) return 0;
    if (a == null) return -1;
    if (b == null) return 1;

    if (typeof a === 'number' && typeof b === 'number') return a - b;
    return String(a).localeCompare(String(b), 'id', { sensitivity:'base' });
  }

  function applyQuerySort(data){
    const q = String(STATE.q || '').trim().toLowerCase();
    let out = data.slice();

    if(q){
      out = out.filter(p => {
        const hay = [
          p.sku, p.name, p.game_name, p.price_type,
          String(p.price||''), String(p.price_per_item||''),
          String(p.active||''), String(p.sort_order||'')
        ].join(' ').toLowerCase();
        return hay.includes(q);
      });
    }

    const k = STATE.sortKey;
    const dir = STATE.sortDir;

    out.sort((x, y) => {
      let ax = x[k], ay = y[k];

      // normalize numeric keys
      if (k === 'sort_order' || k === 'price' || k === 'price_per_item' || k === 'active') {
        ax = Number(ax||0); ay = Number(ay||0);
      }

      // created_at compare as date string
      if (k === 'created_at') {
        ax = new Date(x.created_at || 0).getTime();
        ay = new Date(y.created_at || 0).getTime();
      }

      const r = cmp(ax, ay);
      return dir === 'asc' ? r : -r;
    });

    return out;
  }

  function render(){
    const filtered = applyQuerySort(DATA);
    const total = filtered.length;

    const per = Math.max(1, Number(STATE.perPage || 8));
    const totalPages = Math.max(1, Math.ceil(total / per));
    STATE.page = Math.min(Math.max(1, STATE.page), totalPages);

    const startIdx = (STATE.page - 1) * per;
    const pageItems = filtered.slice(startIdx, startIdx + per);

    $('#countBox').text(total);
    $('#pPageLabel').text(`Page ${STATE.page} / ${totalPages}`);
    $('#pInfo').text(`Menampilkan ${pageItems.length} dari ${total} hasil (total data: ${DATA.length}).`);

    // Desktop table
    $('#pTbody').html(
      pageItems.map(rowHtml).join('') ||
      `<tr><td colspan="7" class="td-muted" style="padding:14px;">No products</td></tr>`
    );

    // Mobile cards
    $('#pCards').html(
      pageItems.map(cardHtml).join('') ||
      `<div class="text-slate-500 text-sm">No products</div>`
    );

    // Pager state
    $('#pPrev').prop('disabled', STATE.page <= 1);
    $('#pNext').prop('disabled', STATE.page >= totalPages);
  }

  async function load(){
    // skeleton
    $('#pTbody').html(`
      <tr><td colspan="7" style="padding:10px 12px;"><div class="skeleton" style="height:22px;border-radius:14px;"></div></td></tr>
      <tr><td colspan="7" style="padding:10px 12px;"><div class="skeleton" style="height:22px;border-radius:14px;"></div></td></tr>
      <tr><td colspan="7" style="padding:10px 12px;"><div class="skeleton" style="height:22px;border-radius:14px;"></div></td></tr>
    `);
    $('#pCards').html(RD.ui.skeletonBlocks(5));

    try {
      const resp = await $.ajax({
        method:'GET',
        url: window.__ADMIN_BASE + '/api/products',
        headers: { 'X-CSRF-Token': window.__CSRF_TOKEN }
      });
      if (!resp.ok) throw new Error(resp.message || 'Failed');

      DATA = resp.data || [];
      render();
    } catch(e) {
      toastr.error(e.responseJSON?.message || e.message || 'Failed load products');
      $('#pTbody').html(`<tr><td colspan="7" class="td-muted" style="padding:14px;color:var(--bad);">Error</td></tr>`);
      $('#pCards').html(`<div class="text-rose-600 text-sm">Error</div>`);
    }
  }

  // Delegated edit/delete
  $(document).off('click', '.js-edit').on('click', '.js-edit', function(){
    const id = String($(this).data('id') || '');
    const p = DATA.find(x => String(x.id) === id);
    if (!p) return;

    $('#pid').val(p.id);
    $('#sku').val(p.sku);
    $('#name').val(p.name);
    $('#game_name').val(p.game_name || 'Royal Dreams');
    $('#price_type').val(p.price_type);
    $('#price').val(p.price);
    $('#price_per_item').val(p.price_per_item);
    $('#active').val(String(p.active));
    $('#sort_order').val(p.sort_order);

    CURRENT_IMAGE = p.image || null;
    if (CURRENT_IMAGE){
      $('#imgPreview').html(`<img src="${CURRENT_IMAGE}" class="w-full h-full object-cover" />`);
    } else {
      $('#imgPreview').html('<i class="ri-image-line" style="font-size:26px;color:rgba(100,116,139,.9)"></i>');
    }

    setMode('edit');
    applyPriceTypeRules();
    toastr.info('Loaded for edit (upload image jika mau ganti)');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  $(document).off('click', '.js-del').on('click', '.js-del', async function(){
    const id = $(this).data('id');
    if (!confirm('Delete product?')) return;

    RD.ui.overlay(true);
    try {
      const resp = await $.ajax({
        method:'DELETE',
        url: window.__ADMIN_BASE + '/api/products/' + id,
        headers: { 'X-CSRF-Token': window.__CSRF_TOKEN }
      });
      if (!resp.ok) throw new Error(resp.message || 'Failed');
      toastr.success('Deleted');

      if(String($('#pid').val()) === String(id)) resetForm();
      await load();
    } catch(e) {
      toastr.error(e.responseJSON?.message || e.message || 'Failed');
    } finally {
      RD.ui.overlay(false);
    }
  });

  // Controls
  $('#pSearch').on('keyup', RD.util.debounce(function(){
    STATE.q = $('#pSearch').val();
    STATE.page = 1;
    render();
  }, 220));

  $('#pPerPage').on('change', function(){
    STATE.perPage = Number($(this).val() || 8);
    STATE.page = 1;
    render();
  });

  $('#pSort').on('change', function(){
    const v = String($(this).val() || 'sort_order:asc');
    const parts = v.split(':');
    STATE.sortKey = parts[0] || 'sort_order';
    STATE.sortDir = parts[1] || 'asc';
    STATE.page = 1;
    render();
  });

  $('#pPrev').on('click', function(){
    STATE.page = Math.max(1, STATE.page - 1);
    render();
    // keep user near pager
    document.getElementById('pPrev').scrollIntoView({ block:'nearest', behavior:'smooth' });
  });

  $('#pNext').on('click', function(){
    STATE.page = STATE.page + 1;
    render();
    document.getElementById('pNext').scrollIntoView({ block:'nearest', behavior:'smooth' });
  });

  $('#reloadBtn, #reloadBtnTop').on('click', function(){
    load();
  });

  // Form interactions
  $('#price_type').on('change', applyPriceTypeRules);

  $('#image').on('change', function(){
    const f = this.files && this.files[0];
    if(!f){
      if(CURRENT_IMAGE){
        $('#imgPreview').html(`<img src="${CURRENT_IMAGE}" class="w-full h-full object-cover" />`);
      } else {
        $('#imgPreview').html('<i class="ri-image-line" style="font-size:26px;color:rgba(100,116,139,.9)"></i>');
      }
      return;
    }
    const url = URL.createObjectURL(f);
    $('#imgPreview').html(`<img src="${url}" class="w-full h-full object-cover" />`);
  });

  $('#resetBtn').on('click', resetForm);
  $('#resetBtnTop').on('click', function(){ resetForm(); toastr.info('New product mode'); });
  $('#cancelEditBtn').on('click', function(){ resetForm(); toastr.info('Edit cancelled'); });

  // Submit
  $('#productForm').on('submit', async function(e){
    e.preventDefault();

    const id = ($('#pid').val() || '').trim();
    const fd = new FormData(this);

    const pt = $('#price_type').val();
    if(pt === 'fixed'){
      fd.set('price_per_item', '0');
    } else {
      fd.set('price', '0');
    }

    RD.ui.overlay(true);
    try {
      let url = window.__ADMIN_BASE + '/api/products';
      let method = 'POST';
      if (id) { url = window.__ADMIN_BASE + '/api/products/' + id; method = 'PUT'; }

      const resp = await $.ajax({
        url,
        method,
        data: fd,
        processData: false,
        contentType: false,
        headers: { 'X-CSRF-Token': window.__CSRF_TOKEN }
      });

      if (!resp.ok) throw new Error(resp.message || 'Failed');

      toastr.success('Saved');
      resetForm();
      await load();
    } catch(e) {
      toastr.error(e.responseJSON?.message || e.message || 'Failed');
    } finally {
      RD.ui.overlay(false);
    }
  });

  // init
  (function init(){
    // keep controls in sync
    STATE.perPage = Number($('#pPerPage').val() || 8);
    const s = String($('#pSort').val() || 'sort_order:asc').split(':');
    STATE.sortKey = s[0] || 'sort_order';
    STATE.sortDir = s[1] || 'asc';

    resetForm();
    load();
  })();
</script>
